language: minimal
sudo: required

git:
  depth: false
  quiet: true

os:
  - linux

env:
- FACTORIO_VERSION=stable
- FACTORIO_VERSION=latest

before_install:
  - export FACTORIO_HEADLESS_COMPRESSED=${HOME}/factorio_headless_x64_${FACTORIO_VERSION}.tar.xz
  - curl -L https://factorio.com/get-download/${FACTORIO_VERSION}/headless/linux64 -o ${FACTORIO_HEADLESS_COMPRESSED}
  - tar xvf ${FACTORIO_HEADLESS_COMPRESSED} --directory ${HOME}
  - export MODS_PATH=${HOME}/mods
  - mkdir ${MODS_PATH}

install:
  - export MOD_DIRECTORY=${PWD##*/}
  - export MOD_NAME_AND_VERSION=$(cat info.json | jq -r '"\(.name)_\(.version)"')
  - pushd ..
  - export MOD_FILE_PATH=${MODS_PATH}/${MOD_NAME_AND_VERSION}.zip
  - zip -0 --exclude=*.git* --exclude=.travis.yml -r ${MOD_FILE_PATH} ${MOD_DIRECTORY}
  - popd

script:
  - export MAP_NAME=test
  - export FACTORIO=${HOME}/factorio/bin/x64/factorio
  - ${FACTORIO} -v --create ${MAP_NAME} --mod-directory ${MODS_PATH}
  - ${FACTORIO} -v --benchmark ${MAP_NAME} --benchmark-ticks 1 --mod-directory ${MODS_PATH}

after_script:

deploy:
  provider: releases
  api_key:
    secure: $ENCRYPTED_GITHUB_OAUTH_TOKEN
  file: $MOD_FILE_PATH
  skip_cleanup: true
  on:
    all_branches: true

      
